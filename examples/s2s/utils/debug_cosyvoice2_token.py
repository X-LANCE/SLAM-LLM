import sys
import os
import soundfile as sf
sys.path.append(os.path.dirname(os.path.abspath(__file__)))
sys.path.append(os.path.join(os.path.dirname(os.path.abspath(__file__)), "third_party/Matcha-TTS"))
from cosyvoice.cli.cosyvoice import CosyVoice,CosyVoice2
import torchaudio
import torch
import uuid

codec_decoder_path = "/nfs/yangguanrou.ygr/ckpts/CosyVoice/CosyVoice2-0.5B"
codec_decoder = CosyVoice2(codec_decoder_path, load_jit=False, load_trt=False, fp16=False)

audio_prompt_path="/nfs/yangguanrou.ygr/codes/CosyVoice/zero_shot_prompt.wav"


from cosyvoice.utils.file_utils import load_wav
prompt_speech_16k = load_wav(audio_prompt_path, 16000)
flow_prompt_speech_token, flow_prompt_speech_token_len = codec_decoder.frontend._extract_speech_token(prompt_speech_16k)
prompt_speech_24000 = torchaudio.transforms.Resample(orig_freq=16000, new_freq=24000)(prompt_speech_16k)
prompt_speech_feat, prompt_speech_feat_len = codec_decoder.frontend._extract_speech_feat(prompt_speech_24000)
flow_embedding = codec_decoder.frontend._extract_spk_embedding(prompt_speech_16k)

this_uuid = str(uuid.uuid1())
speed=1.0
audio_tokens=[3707, 6486, 6486, 6486, 6486, 6486, 6405, 6405, 6405, 6405, 6405, 6405, 4218, 2148, 6376, 2261, 5273, 2326, 60, 5019, 4849, 2861, 593, 1970, 1805, 1481, 2050, 6453, 6537, 688, 5594, 4879, 4966, 2841, 4947, 502, 1946, 1460, 224, 3705, 5319, 883, 2909, 3590, 6425, 6421, 4233, 4299, 4218, 3648, 3975, 4218, 4299, 4299, 4299, 5758, 4947, 494, 2702, 3178, 5691, 4668, 4839, 3840, 6044, 4490, 2278, 6501, 6261, 2166, 2539, 6238, 4382, 2698, 2698, 35, 1587, 1045, 734, 3799, 160, 1697, 716, 5102, 3541, 6537, 6537, 2906, 5084, 5774, 6421, 6420, 4299, 3651, 2922, 5109, 5838, 5109, 816, 2922, 6052, 5322, 4440, 4606, 5021, 3563, 1212, 84, 3015, 4852, 4763, 2576, 380, 1271, 1848, 1950, 162, 3321, 2763, 4772, 4615, 3563, 1862, 5889, 6048, 6048, 4104, 6557, 5830, 5080, 4871, 4860, 4860, 4860, 3411, 2681, 1358, 1837, 306, 3161, 569, 2417, 2085, 5408, 2445, 3481, 1294, 1203, 5244, 6057, 5979, 5340, 3074, 1272, 32, 1679, 1942, 1691, 734, 29, 775, 1479, 3648, 3975, 4299, 6486, 6486, 6486, 6405, 6405, 6405, 6405, 4218]
#audio_tokens = [536, 693, 561, 561, 561, 561, 561, 561, 561, 66, 66, 66, 66, 66, 66, 66, 249, 685, 685, 3190, 710, 710, 293, 310, 468, 1700, 1700, 468, 472, 472, 468, 269, 2723, 2344, 79, 311, 563, 425, 77, 550, 312, 2644, 312, 613, 253, 613, 2297, 12, 2891, 448, 448, 4, 386, 290, 308, 2752, 20, 69, 460, 460, 460, 466, 465, 212, 50, 387, 590, 311, 51, 51, 51, 51, 51, 384, 164, 415, 139, 139, 121, 2444, 2444, 249, 249, 262, 249, 287, 3821, 124, 211, 733, 515, 227, 227, 465, 49, 343, 1354, 1354, 47, 104, 33, 33, 27, 2302, 681, 33, 179, 39, 2031, 90, 297, 263, 982, 1091, 1091, 132, 61, 550, 1006, 1006, 550, 535, 535, 390, 406, 457, 434, 298, 54, 1073, 355, 15, 553, 426, 426, 3290, 7, 215, 57, 345, 1423, 249, 19, 271, 149, 262, 680, 657, 327, 1849, 249, 670, 230, 230, 230, 3238, 3238, 3238, 3238, 3238, 53, 678, 1089, 124, 226, 726, 726, 212, 335, 217, 11, 20, 534, 534, 534, 534, 3052, 700, 47, 47, 1930, 595, 59, 2330, 473, 2592, 212, 515, 212, 212, 212, 212, 212, 351, 594, 594, 173, 173, 460, 701, 144, 249, 249, 2444, 249, 249, 249, 2444, 436, 436, 121, 149, 377, 3132, 376, 2454, 415, 415, 655, 389, 165, 483, 183, 183, 515, 565, 506, 47, 1307, 403, 3254, 502, 1935, 386, 290, 247, 403, 160, 137, 3254, 502, 903, 386, 210, 210, 335, 223, 1006, 1006, 550, 550, 550, 550, 372, 649, 360, 121, 121, 249, 249, 249, 249, 670, 670, 670, 442, 442, 442, 442, 442, 442, 216, 442, 140, 345, 631, 710, 124, 1261, 1935, 3889, 4, 648, 2723, 39, 2031, 1, 184, 184, 446, 122, 192, 361, 1, 1, 107, 130, 187, 9, 115, 284, 28, 706, 77, 3575, 3575, 570, 595, 253, 420, 298, 476, 3836, 618, 540, 540, 621, 519, 9, 1037, 1037, 1037, 2297, 1357, 19, 598, 216, 216, 216, 216, 442, 53, 8, 1089, 596, 67, 256, 286, 300, 609, 260, 289, 250, 570, 15, 15, 713, 177, 90, 90, 39, 157, 127, 3254, 3821, 28, 502, 2188, 4, 4, 386, 386, 448, 269, 269, 199, 199, 199, 1700, 687, 687, 298, 47, 47, 309, 726, 383, 465, 465, 465, 466, 47, 323, 101, 399, 137, 187, 292, 297, 424, 3, 358, 533, 213, 728, 585, 3350, 686, 686, 83, 399, 456, 28, 374, 3290, 2644, 1460, 82, 82, 1035, 1035, 1035, 1035, 262, 262, 262, 505, 291, 331, 331, 331, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66]
audio_tokens = torch.tensor(audio_tokens)
audio_tokens = audio_tokens.unsqueeze(0)
print(audio_tokens.shape)
# audio_tokens=[ audio_tokens]
audio_hat = codec_decoder.model.token2wav(
    token=audio_tokens,
    prompt_token=flow_prompt_speech_token,
    prompt_feat=prompt_speech_feat,
    embedding=flow_embedding,
    uuid=this_uuid,
    token_offset=0,
    finalize=True,
    speed=speed
)        
speech_sample_rate=24000

sf.write("/nfs/yangguanrou.ygr/codes/SLAM-LLM/examples/s2s/utils/debug_24000_ygr.wav", audio_hat.squeeze().cpu().numpy(), speech_sample_rate)


# 24000!!!!